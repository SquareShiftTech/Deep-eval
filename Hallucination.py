from deepeval import evaluate
from deepeval.metrics import HallucinationMetric
from deepeval.test_case import LLMTestCase


context = ["""{    "data": {"admission":{"ADMISSION_LOCATION":["PHYS REFERRAL/NORMAL DELI"],"ADMISSION_TYPE":["ELECTIVE"],"ADMITTIME":["2175-10-02 12:30:00"],"DEATHTIME":[null],"DIAGNOSIS":["CORONARY ARTERY DISEASE\\CORONARY ARTERY BYPASS GRAFT /SDA"],"DISCHARGE_LOCATION":["SNF"],"DISCHTIME":["2175-10-06 15:00:00"],"EDOUTTIME":[null],"EDREGTIME":[null],"ETHNICITY":["WHITE"],"HADM_ID":[110958],"HAS_CHARTEVENTS_DATA":[1],"HOSPITAL_EXPIRE_FLAG":[0],"INSURANCE":["Medicare"],"LANGUAGE":["ENGL"],"MARITAL_STATUS":["WIDOWED"],"RELIGION":["CATHOLIC"],"SUBJECT_ID":[43927]},"chart_url":"https://storage.googleapis.com/sutrobio-discharge-bucket/Patients/43927/110958/heart_rate_chart.png","diagnosis":"**Diagnosis Report**\n\n**Patient ID:** 43927\n**Admission ID:** 110958\n\n**Summary of Primary Health Concerns:**\n\nThis report summarizes the significant diagnoses for patient 43927, revealing a complex clinical picture dominated by significant coronary artery disease (CAD), complicated by several co-morbidities. The patient presents with coronary atherosclerosis, including chronic total occlusion of a coronary artery, and angina pectoris.  This necessitates aggressive cardiovascular risk management.  Further compounding the cardiac risk are uncontrolled Type II diabetes mellitus, hypertension, and hyperlipidemia.  The patient also exhibits a history of carotid artery occlusion and stenosis, along with asthma, adding significant respiratory and cerebrovascular risk factors.\n\n\n**Analysis of Interconnected Conditions and Potential Complications:**\n\nThe patient's CAD is the most critical concern, requiring immediate attention.  The chronic total occlusion represents a high-risk state, potentially leading to myocardial infarction or other severe cardiac events.  Angina pectoris underscores the symptomatic nature of his CAD.  The co-existence of hypertension, hyperlipidemia, and diabetes mellitus significantly exacerbates the risk of adverse cardiac events.  These conditions are all well-established risk factors for accelerated atherosclerosis, increasing the likelihood of further occlusions and cardiac complications.\n\nThe uncontrolled Type II diabetes mellitus represents a major concern, contributing significantly to the vascular complications.  Poorly controlled blood glucose levels promote atherosclerotic plaque formation and progression, worsening both coronary and peripheral vascular disease.\n\nThe history of carotid artery occlusion and stenosis poses a significant cerebrovascular risk, increasing the chance of stroke.  This underscores the importance of comprehensive cardiovascular risk factor control.\n\nThe presence of asthma introduces respiratory complications that could potentially influence cardiac management and recovery.  Careful assessment and management of asthma symptoms are crucial.\n\nPast medical history of urinary calculi and colonic polyps, while not directly related to the immediate cardiac concerns, indicate a tendency towards certain metabolic and gastrointestinal disorders, warranting further evaluation and potentially preventive measures.\n\nThe past history of percutaneous transluminal coronary angioplasty (PTCA) suggests prior intervention for CAD, indicating a progression of the disease despite previous treatment.\n\n\n**Recommendations for Treatment and Health Management:**\n\nThis patient requires a multifaceted treatment strategy focusing on aggressive cardiovascular risk reduction and management of co-morbidities.  Specific recommendations include:\n\n* **Cardiac Management:**  A comprehensive cardiac evaluation including coronary angiography, stress testing, and potentially further revascularization procedures (e.g., PCI, CABG) should be considered based on the severity of the stenosis and the patient's clinical presentation.  Medical management must include optimal medical therapy for CAD, including antiplatelet agents, statins (high-intensity), ACE inhibitors/ARBs, and beta-blockers.\n\n* **Diabetes Management:**  Intensive management of diabetes mellitus is crucial, focusing on achieving and maintaining optimal glycemic control through dietary modification, exercise, and potentially pharmacologic intervention (e.g., insulin, oral hypoglycemics).\n\n* **Hypertension Management:**  Strict blood pressure control is essential.  Pharmacologic management will likely be necessary, guided by regular monitoring.\n\n* **Hyperlipidemia Management:**  Aggressive lipid-lowering therapy with high-intensity statins is indicated to reduce LDL cholesterol levels significantly.\n\n* **Carotid Artery Disease:**  Further assessment of the carotid arteries is recommended to determine the extent of stenosis and the need for intervention (e.g., carotid endarterectomy).\n\n* **Asthma Management:**  Appropriate asthma management is essential, including bronchodilators and/or inhaled corticosteroids as needed to prevent exacerbations.\n\n* **Lifestyle Modifications:**  Significant lifestyle changes are crucial, including dietary modifications (low-fat, low-sodium, low-sugar diet), regular exercise (at least 30 minutes most days of the week), smoking cessation (if applicable), and stress management techniques.\n\n* **Follow-up:**  Close and frequent follow-up appointments are necessary for monitoring blood pressure, blood glucose levels, lipid profiles, and for ongoing evaluation of cardiac function.  Regular monitoring of cardiac risk factors and clinical status is essential.\n\n\n\nThis report provides a preliminary analysis based on the available data. Further investigations and detailed clinical assessment are necessary for a comprehensive understanding of the patient's condition and development of an individualized treatment plan.\n","icu":{"DBSOURCE":["metavision"],"FIRST_CAREUNIT":["CSRU"],"FIRST_WARDID":[15],"HADM_ID":[110958],"ICUSTAY_ID":[290513],"INTIME":["2175-10-02 10:45:01"],"LAST_CAREUNIT":["CSRU"],"LAST_WARDID":[15],"LOS":[1.3153],"OUTTIME":["2175-10-03 18:19:00"],"SUBJECT_ID":[43927]},"patient":{"DOB":["2104-02-12 00:00:00"],"GENDER":["F"],"SUBJECT_ID":[43927]},"procedures":"**Patient Information**\n\nSubject ID: 43927\nHospital Admission ID: 110958\nICUSTAY_ID: 290513\n\n\n**Procedures and Outcomes**\n\nThe patient underwent several procedures during their hospital stay.\n\n* **(Aorto)coronary bypass of two coronary arteries (Aortocor bypas-2 cor art):** This procedure aimed to improve blood flow to the heart by bypassing blocked coronary arteries.  The exact start and end times are not specified in the provided data.\n\n* **Single internal mammary-coronary artery bypass (1 int mam-cor art bypass):**  This procedure, also aimed at improving coronary blood flow, involved using an internal mammary artery to bypass a blocked coronary artery. The exact start and end times are not specified in the provided data.\n\n* **Extracorporeal circulation auxiliary to open heart surgery (Extracorporeal circulat):** This procedure involved using a heart-lung machine to support the patient's circulation during the open heart surgery. The exact start and end times are not specified in the provided data.\n\n\nThe procedures were supported by various other interventions: Chest X-rays were performed on 2175-10-02 at 14:50 and 2175-10-03 at 13:30, each lasting approximately 1 minute.  A nasal swab was taken on 2175-10-02 at 14:30 lasting approximately 1 minute.  Invasive ventilation was administered from 14:20 to 18:10 on 2175-10-02 for a duration of 230 minutes.  A multi-lumen line was placed at 14:22 on 2175-10-02 and removed at 18:19 on 2175-10-03.  The patient received an arterial line at 14:22 on 2175-10-02, which remained in place until 08:50 on 2175-10-03, a total of 18 hours and 28 minutes. A 16-gauge peripheral line was inserted at 14:24 on 2175-10-02 and removed at 06:00 on 2175-10-03.  The patient was received in the OR at 14:30 on 2175-10-02, lasting about 1 minute. Intubation occurred at 14:30 on 2175-10-02 and extubation at 18:15 on 2175-10-02, each lasting approximately 1 minute. No adverse events were noted related to these procedures.\n\n\n**Overall Treatment Progression**\n\nThe patient's hospital course involved open heart surgery including coronary artery bypass grafting, supported by extracorporeal circulation.  The patient required invasive ventilation for a significant period.  Multiple invasive lines were placed for hemodynamic monitoring and medication administration.  Post-operative monitoring included chest x-rays. The patient's overall progress is not fully detailed in the provided data, but the procedures suggest a successful surgical outcome.  The recovery period, as indicated by the duration of the invasive lines and ventilation, was substantial.\n","subject_id":43927,"transfer":{"CURR_CAREUNIT":[null,null,"CSRU",null],"CURR_WARDID":[27,2,15,null],"DBSOURCE":["metavision","metavision","metavision","metavision"],"EVENTTYPE":["admit","transfer","transfer","discharge"],"HADM_ID":[110958,110958,110958,110958],"ICUSTAY_ID":[null,null,290513,null],"INTIME":["2175-10-02 00:40:40","2175-10-03 18:19:00","2175-10-02 10:45:01","2175-10-06 16:56:08"],"LOS":[10.07,70.62,31.57,null],"OUTTIME":["2175-10-02 10:45:01","2175-10-06 16:56:08","2175-10-03 18:19:00",null],"PREV_CAREUNIT":[null,"CSRU",null,null],"PREV_WARDID":[null,15,27,2],"SUBJECT_ID":[43927,43927,43927,43927]}}
}"""]


actual_output="markdown""## Discharge Report\n\n**Patient Details:**\n\n* **Patient ID:** 43927\n* **Gender:** Female\n* **Date of Birth:** 2104-02-12\n* **Date of Death:** N/A\n\n**Admission Information:**\n\n* **Admission Date:** 2175-10-02\n* **Admission Time:** 12:30:00 PM\n* **Discharge Date:** 2175-10-06\n* **Discharge Time:** 15:00:00\n* **Admission Type:** Elective\n* **Admission Location:** PHYS REFERRAL/NORMAL DELI\n* **Discharge Location:** SNF\n* **Insurance:** Medicare\n* **Primary Diagnosis:** CORONARY ARTERY DISEASE\\CORONARY ARTERY BYPASS GRAFT /SDA\n\n**Hospital Stay Summary:**\n\nPatient 43927 was admitted electively on 2175-10-02 at 12:30:00 PM from PHYS REFERRAL/NORMAL DELI for CORONARY ARTERY DISEASE\\CORONARY ARTERY BYPASS GRAFT /SDA. The patient's initial stay began on the ward at 2175-10-02 00:40:40 and transferred to the CSRU at 2175-10-02 10:45:01. Their ICU stay was 1.3153 days, ending on 2175-10-03 at 18:19:00. The patient subsequently transferred back to the ward from the CSRU on 2175-10-03 at 18:19:00. Following a prolonged ward stay, the patient was discharged to SNF on 2175-10-06 at 15:00:00.\n\n**Heart Rate Trend:**\n\n![Heart Rate Trend](path/to/heart_rate_line.png)\n\n**Diagnoses:**\n\nPatient 43927 was diagnosed with the following conditions:\n\n* **Coronary artery disease (CAD)**, including chronic total occlusion of a coronary artery and angina pectoris (ICD9 code: [Provide ICD9 codes for CAD, chronic total occlusion, and angina pectoris]).\n* **Type II diabetes mellitus** (ICD9 code: [Provide ICD9 code for Type II diabetes mellitus]).\n* **Hypertension** (ICD9 code: [Provide ICD9 code for hypertension]).\n* **Hyperlipidemia** (ICD9 code: [Provide ICD9 code for hyperlipidemia]).\n* **Carotid artery occlusion and stenosis** (ICD9 code: [Provide ICD9 code for carotid artery occlusion and stenosis]).\n* **Asthma** (ICD9 code: [Provide ICD9 code for asthma]).\n\nThe patient also has a past medical history of urinary calculi and colonic polyps.\n\n**Treatment Summary:**\n\nThis patient, admitted for open heart surgery, underwent a complex procedure involving multiple coronary artery bypass grafts. The surgery required the use of a heart-lung machine, highlighting the critical nature of their condition. \n\nThe patient's recovery was monitored closely, including frequent chest X-rays and the use of a ventilator for an extended period. This suggests a significant period of respiratory support was necessary. Multiple invasive lines, including an arterial line and a multi-lumen line, were placed for monitoring their vital signs and administering medications, reflecting the need for close observation and intervention. \n\nWhile the patient's post-operative progress is not fully described, the procedures performed and their duration suggest a successful surgical outcome, followed by a substantial recovery period. However, the extended need for invasive lines and ventilation implies a significant level of medical intervention and monitoring during their stay.\n\nFurther details regarding their overall progress and potential ongoing treatment needs after discharge would require additional information from the patient's medical record. However, this summary highlights the complexity of the patient's condition and the significant medical interventions required to manage their care.\n\n**Discharge Medications:**\n\n| Medication | Dose | Route | Frequency | Duration / Instructions |\n|---|---|---|---|---|\n| Fluticasone-Salmeterol Diskus (250/50) | 1 inhalation | Inhaler | Twice daily | As needed for shortness of breath |\n| Atorvastatin | 40 mg | Oral | Once daily | In the evening |\n| Montelukast Sodium | 10 mg | Oral | Once daily | In the evening |\n| Clopidogrel | 75 mg | Oral | Once daily |  |\n| Acetaminophen | 650 mg | Oral | Every 4-6 hours | As needed for pain, not to exceed 3000 mg in 24 hours |\n| Artificial Tears Preservative-Free | 1-2 drops | Both eyes | As needed | For dryness |\n| Metformin XR (Glucophage XR) | 500 mg | Oral | Once daily | With the evening meal |\n| Insulin | As directed |  |  | By the patient's endocrinologist |\n| Metoprolol Tartrate | 75 mg | Oral | Once daily |  |\n\n**Discharge Instructions:**\n\n* **Activity Level:** Gradually increase activity levels. Rest is encouraged, with a focus on light activities like walking. Avoid heavy lifting and strenuous exercise until cleared by your healthcare provider. \n\n* **Diet:** Follow a balanced, heart-healthy diet that is low in sodium and fat. For patients with diabetes, monitor blood sugar levels closely and prioritize low-glycemic foods. Those with renal issues should limit potassium, phosphorus, and sodium intake.\n\n* **Home Care Instructions:** Ensure all medications are taken as prescribed. Monitor blood pressure, blood sugar levels, and watch for any signs of infection or complications. Keep wounds clean and dry if applicable.\n\n* **Medication Schedule:** Adhere strictly to the prescribed medication schedule. Do not skip doses. Regular blood tests may be needed for adjusting medications such as Warfarin or insulin. \n\n* **Follow-up Appointments:** Schedule appointments with your primary care physician, cardiologist, and nephrologist to monitor progress. Regular check-ups are crucial for managing chronic conditions.\n\n* **Therapeutic Exercises:** Engage in gentle exercises like walking or stretching to promote circulation and overall health. Avoid high-intensity workouts until approved by your doctor.\n\n* **Dietary Guidelines:** Eat a diet rich in vegetables, lean proteins, and whole grains. Limit salt, sugar, and unhealthy fats. For kidney patients, avoid foods high in potassium like bananas and oranges. \n\n* **Emergency Signs:** Seek immediate medical attention if experiencing symptoms like chest pain, shortness of breath, sudden weight gain, severe swelling, or signs of infection (fever, redness, or pus at wound sites). \n\n**Please note:** This is a sample medication list generated based on the provided data.  It is not a substitute for personalized medical advice. Patients should always consult with their healthcare provider for the most accurate and appropriate medication information for their individual needs. \n"
test_case = LLMTestCase(
    input="Summarize the patient details",
    actual_output=actual_output,
    context=context
)
metric = HallucinationMetric(threshold=0.5)

metric.measure(test_case)
print(metric.score)
print(metric.reason)


evaluate([test_case], [metric])